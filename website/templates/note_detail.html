{% extends 'base.html' %}
{% include 'shared_modal.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/note_detail.css') }}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Sidebar -->
    <div class="note-sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('views.share_with_me') if shared else url_for('views.all_my_notes') }}" class="back-btn">
                <i class="bi bi-arrow-left"></i> Back to {{ 'Shared Notes' if shared else 'My Notes' }}
            </a>
        </div>
        <div class="sidebar-content">
            <!-- Note Meta Info -->
            <div class="note-meta">
                <span class="meta-label">Created</span>
                <span class="meta-value">{{ note.created_at.strftime('%d %b %Y') }}</span>
            </div>
            <div class="note-meta">
                <span class="meta-label">Last modified</span>
                <span class="meta-value">{{ note.updated_at.strftime('%d %b %Y, %H:%M') }}</span>
            </div>
            {% if shared and sharer %}
            <div class="note-meta">
                <span class="meta-label">Shared by</span>
                <span class="meta-value">{{ sharer.first_name }} {{ sharer.last_name }}</span>
            </div>
            {% endif %}

            <!-- Color Indicator -->
            <div class="note-meta">
                <span class="meta-label">Note Color</span>
                <div class="color-indicator {{ note.color }}"></div>
            </div>

            <!-- Tags Section -->
            <div class="note-meta">
                <span class="meta-label">Tags</span>
                <div class="tags-container">
                    <span class="tag">Study</span>
                    <span class="tag">Important</span>
                    <span class="tag">+Add</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                {% if note.user_id == current_user.id or (shared and shared.can_edit) %}
                <a href="{{ url_for('views.edit_note', note_id=note.id) }}" class="btn btn-edit">
                    <i class="bi bi-pencil"></i> Edit Note
                </a>
                {% endif %}
                <button class="btn btn-share" data-bs-toggle="modal" data-bs-target="#shareNoteModal" data-note-id="{{ note.id }}">
                    <i class="bi bi-share"></i> Share
                </button>
                <button class="btn btn-export">
                    <i class="bi bi-download"></i> Export as PDF
                </button>
                {% if note.user_id == current_user.id %}
                <button class="btn btn-delete">
                    <i class="bi bi-trash"></i> Move to Trash
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="note-main-content">
        <!-- View Mode -->
        <div id="viewMode" style="display: {% if editing|default(False) %}none{% else %}block{% endif %};">
            <div class="note-header">
                <h1 class="note-title">{{ note.title }}</h1>
            </div>
            <div class="note-body">
                {{ note.content | safe }}
            </div>
        </div>

        <!-- Edit Mode -->
        <div id="editMode" style="display: {% if editing|default(False) %}block{% else %}none{% endif %};">
            <div class="edit-container">
                <div class="edit-header">
                    <input type="text" id="editTitle" class="edit-title" value="{{ note.title }}">
                    <div class="edit-actions">
                        <select id="editColor" class="form-select color-select">
                            <option value="note-blue" {% if note.color == 'note-blue' %}selected{% endif %}>Blue Theme</option>
                            <option value="note-green" {% if note.color == 'note-green' %}selected{% endif %}>Green Theme</option>
                            <option value="note-purple" {% if note.color == 'note-purple' %}selected{% endif %}>Purple Theme</option>
                        </select>
                        <button class="btn btn-cancel" onclick="toggleEditMode()">Cancel</button>
                        <button class="btn btn-save" onclick="saveNote()">Save Changes</button>
                    </div>
                </div>
                <textarea id="editContent" class="edit-content">{{ note.content }}</textarea>
            </div>
        </div>
    </div>
</div>

<script>
function toggleEditMode() {
    const viewMode = document.getElementById('viewMode');
    const editMode = document.getElementById('editMode');
    
    if (viewMode.style.display !== 'none') {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    } else {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
    }
}

function saveNote() {
    const noteId = '{{ note.id }}';
    const data = {
        title: document.getElementById('editTitle').value,
        content: document.getElementById('editContent').value,
        color: document.getElementById('editColor').value
    };

    fetch(`/api/notes/edit/${noteId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.href = `/note_detail/${noteId}`;
        } else {
            alert('Error updating note: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating note');
    });
}

// Gán sự kiện cho nút Share trong trang note_detail
document.querySelectorAll('.btn-share').forEach(button => {
    button.addEventListener('click', function() {
        const noteId = this.getAttribute('data-note-id');
        const noteIdInput = document.getElementById('noteIdToShare');
        if (noteIdInput) {
            noteIdInput.value = noteId;
        }
    });
});
</script>
{% endblock %}