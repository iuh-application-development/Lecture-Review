{% extends 'base.html' %}
{% include 'shared_modal.html' %}

{% block head %}
<!-- Thêm link đến file CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/note_detail.css') }}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Sidebar -->
    <div class="note-sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('views.all_my_notes') }}" class="back-btn">
                <i class="bi bi-arrow-left"></i> Back to Notes
            </a>
        </div>
        <div class="sidebar-content">
            <!-- Note Meta Info -->
            <div class="note-meta">
                <span class="meta-label">Created</span>
                <span class="meta-value">{{ note.created_at.strftime('%d %b %Y') }}</span>
            </div>
            <div class="note-meta">
                <span class="meta-label">Last modified</span>
                <span class="meta-value">{{ note.updated_at.strftime('%d %b %Y, %H:%M') }}</span>
            </div>

            <!-- Color Indicator -->
            <div class="note-meta">
                <span class="meta-label">Note Color</span>
                <div class="color-indicator {{ note.color }}"></div>
            </div>

            <!-- Tags Section -->
            <div class="note-meta">
                <span class="meta-label">Tags</span>
                <div class="tags-container">
                    <span class="tag">Study</span>
                    <span class="tag">Important</span>
                    <span class="tag">+Add</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-edit" onclick="toggleEditMode()">
                    <i class="bi bi-pencil"></i> Edit Note
                </button>
                <button class="btn btn-share" data-bs-toggle="modal" data-bs-target="#shareNoteModal" data-note-id="{{ note.id }}">
                    <i class="bi bi-share"></i> Share
                </button>
                <button class="btn btn-export">
                    <i class="bi bi-download"></i> Export as PDF
                </button>
                <button class="btn btn-delete">
                    <i class="bi bi-trash"></i> Move to Trash
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="note-main-content">
        <!-- View Mode -->
        <div id="viewMode">
            <div class="note-header">
                <h1 class="note-title">{{ note.title }}</h1>
            </div>
            <div class="note-body">
                {{ note.content | safe }}
            </div>
        </div>

        <!-- Edit Mode -->
        <div id="editMode" style="display: none;">
            <div class="edit-container">
                <div class="edit-header">
                    <input type="text" id="editTitle" class="edit-title" value="{{ note.title }}">
                    <div class="edit-actions">
                        <select id="editColor" class="form-select color-select">
                            <option value="note-blue" {% if note.color == 'note-blue' %}selected{% endif %}>Blue Theme</option>
                            <option value="note-green" {% if note.color == 'note-green' %}selected{% endif %}>Green Theme</option>
                            <option value="note-purple" {% if note.color == 'note-purple' %}selected{% endif %}>Purple Theme</option>
                        </select>
                        <button class="btn btn-cancel" onclick="toggleEditMode()">Cancel</button>
                        <button class="btn btn-save" onclick="saveNote()">Save Changes</button>
                    </div>
                </div>
                <textarea id="editContent" class="edit-content">{{ note.content }}</textarea>
            </div>
        </div>
    </div>
</div>

<script>
function toggleEditMode() {
    const viewMode = document.getElementById('viewMode');
    const editMode = document.getElementById('editMode');
    
    if (viewMode.style.display !== 'none') {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    } else {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
    }
}

function saveNote() {
    const noteId = '{{ note.id }}';
    const data = {
        title: document.getElementById('editTitle').value,
        content: document.getElementById('editContent').value,
        color: document.getElementById('editColor').value
    };

    fetch(`/api/notes/edit/${noteId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Refresh page to show updated content
            window.location.reload();
        } else {
            alert('Error updating note');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating note');
    });
}

// Xử lý sự kiện nhấn nút Share
document.getElementById('shareNoteBtn').addEventListener('click', async function () {
    const noteId = document.getElementById('noteIdToShare').value;
    const recipientEmail = document.getElementById('shareEmail').value;

    if (!recipientEmail) {
        alert("Please enter the recipient's email!");
        return;
    }

     try {
        const response = await fetch('/api/share-note', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                note_id: noteId,
                recipient_email: recipientEmail,
            }),
        });

        const result = await response.json();
        if (result.success) {
            // Hiển thị thông báo thành công
            alert('Share successfully!');
                
            // Đóng modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('shareNoteModal'));
            modal.hide();

            // Reset form
            document.getElementById('shareNoteForm').reset();
        } else {
            alert('Failed to share note: ' + result.message);
        }
    } catch (error) {
        console.error('Error sharing note:', error);
        alert('Error sharing note. Please try again.');
    }
});

// Gán giá trị note ID vào modal khi nhấn nút Share
document.querySelectorAll('.share-note,.btn-share').forEach(button => {
    button.document.addEventListener('click', function(e) {
        const shareBtn = e.target.closest('.share-note, .btn-share');
        if (shareBtn) {
            e.preventDefault();
            const noteId = shareBtn.getAttribute('data-note-id');
            document.getElementById('noteIdToShare').value = noteId;
        }
    });
});

</script>
{% endblock %}

