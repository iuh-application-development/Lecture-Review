{% extends 'base.html' %}
{% block content %}
<div class="content p-4 flex-grow-1">
    <div class="title-block p-2 px-3 mb-3">
        <h5 class="fw-bold m-0">My Notes</h5>
    </div>
    <div id="myNotesContainer" class="d-flex flex-wrap gap-3 mb-5">
        <!-- Các note card sẽ được hiển thị ở đây -->
    </div>

    <div class="title-block p-2 px-3 mb-3">
        <h5 class="fw-bold m-0">Shared</h5>
    </div>
    <div class="d-flex flex-wrap gap-3 mb-5">
        <div class="note-card note-green position-relative p-3">
            <div class="note-header d-flex justify-content-between align-items-start pb-1">
                <strong><em>Tiêu đề</em></strong>
                <div class="dropdown">
                    <button class="btn btn-link p-0 border-0" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editNoteModal">
                                <i class="bi bi-pencil-fill"></i> Edit
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#">
                                <i class="bi bi-share-fill"></i> Share
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item text-danger" href="#">
                                <i class="bi bi-trash3-fill"></i> Delete
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card-separator"></div>
            <p class="mt-2">Nội dung</p>
        </div>
        <div class="note-card note-blue position-relative p-3">
            <div class="note-header d-flex justify-content-between align-items-start pb-1">
                <strong><em>Tiêu đề</em></strong>
                <div class="dropdown">
                    <button class="btn btn-link p-0 border-0" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editNoteModal">
                                <i class="bi bi-pencil-fill"></i> Edit
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#">
                                <i class="bi bi-share-fill"></i> Share
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item text-danger" href="#">
                                <i class="bi bi-trash3-fill"></i> Delete
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card-separator"></div>
            <p class="mt-2">Nội dung</p>
        </div>
        <div class="note-card note-purple position-relative p-3">
            <div class="note-header d-flex justify-content-between align-items-start pb-1">
                <strong><em>Tiêu đề</em></strong>
                <div class="dropdown">
                    <button class="btn btn-link p-0 border-0" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editNoteModal">
                                <i class="bi bi-pencil-fill"></i> Edit
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#">
                                <i class="bi bi-share-fill"></i> Share
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item text-danger" href="#">
                                <i class="bi bi-trash3-fill"></i> Delete
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card-separator"></div>
            <p class="mt-2">Nội dung</p>
        </div>
        <!-- Các card khác tương tự -->
    </div>

    <!-- Nút create - đặt ở cuối content area -->
    <button type="button" class="btn btn-dark rounded-circle position-fixed"
        style="bottom: 30px; right: 30px; width: 50px; height: 50px;" data-bs-toggle="modal"
        data-bs-target="#createNoteModal">
        +
    </button>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4">
            <form action="/api/notes/edit/{{1}}" method="POST" id="editNoteForm">
                <h4 class="text-center mb-4 edit-note-title">Edit Note</h4>
                <!-- Color Picker với các lựa chọn: note-green, note-blue, note-purple -->
                <div class="d-flex justify-content-center gap-2 mb-4">
                    <div class="color-pick note-green" data-color="note-green"></div>
                    <div class="color-pick note-blue" data-color="note-blue"></div>
                    <div class="color-pick note-purple" data-color="note-purple"></div>
                </div>
                <div class="mb-3">
                    <label for="editNoteTitle" class="form-label">Title</label>
                    <input type="text" class="form-control" id="editNoteTitle" name="title">
                </div>
                <div class="mb-4">
                    <label for="editNoteContent" class="form-label">Content</label>
                    <textarea class="form-control" id="editNoteContent" rows="4" name="content"></textarea>
                </div>
                <input type="hidden" name="color" id="editNoteColor" value="">
                <div class="d-flex justify-content-end gap-2">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Create Note -->
<div class="modal" id="createNoteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4">
            <form action="/api/notes/create" method="POST" id="createNoteForm">
                <h4 class="text-center mb-3">Create new note</h4>
                <!-- Color Picker với các lựa chọn: note-green, note-blue, note-purple -->
                <div class="d-flex justify-content-center gap-2 mb-4">
                    <div class="color-pick note-green" data-color="note-green"></div>
                    <div class="color-pick note-blue" data-color="note-blue"></div>
                    <div class="color-pick note-purple" data-color="note-purple"></div>
                </div>
                <div class="mb-3">
                    <label for="createNoteTitle" class="form-label">Title</label>
                    <input type="text" class="form-control" id="createNoteTitle" name="title">
                </div>
                <div class="mb-4">
                    <label for="createNoteContent" class="form-label">Content</label>
                    <textarea class="form-control" rows="6" id="createNoteContent" name="content"></textarea>
                </div>
                <!-- Hidden field cho color, mặc định là note-green -->
                <input type="hidden" name="color" id="createNoteColor" value="note-green">
                <!-- Nếu cần, thêm hidden field cho user_id -->
                <input type="hidden" name="user_id" id="createNoteUserId" value="{{ user.id }}">
                <div class="d-flex justify-content-center gap-2">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Xử lý chọn màu trong modal Create Note
    const createColorPicks = document.querySelectorAll('#createNoteModal .color-pick');
    createColorPicks.forEach(colorPick => {
        colorPick.addEventListener('click', function() {
            // Xóa class 'selected' khỏi tất cả các phần tử chọn màu
            createColorPicks.forEach(item => item.classList.remove('selected'));
            // Thêm class 'selected' cho phần tử được chọn
            this.classList.add('selected');
            // Cập nhật giá trị của trường hidden
            document.getElementById('createNoteColor').value = this.getAttribute('data-color');
        });
    });

    // Xử lý submit form Create Note bằng fetch API
    const createNoteForm = document.getElementById('createNoteForm');
    createNoteForm.addEventListener('submit', function (event) {
        event.preventDefault(); // Ngăn submit mặc định

        const title = document.getElementById('createNoteTitle').value;
        const content = document.getElementById('createNoteContent').value;
        const color = document.getElementById('createNoteColor').value;
        const userIdField = document.getElementById('createNoteUserId');
        const user_id = userIdField ? userIdField.value : null;

        const payload = { title, content, color, user_id };

        fetch('/api/notes/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.redirect) {
                window.location.href = data.redirect;
            } else {
                console.error('Lỗi khi tạo note:', data);
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // Gọi API để lấy tối đa 9 note và hiển thị
    fetch('/api/notes?limit=9')
        .then(response => response.json())
        .then(data => {
            const notes = data.data || data;
            const container = document.getElementById('myNotesContainer');
            container.innerHTML = '';

            notes.forEach(note => {
                const noteCard = document.createElement('div');
                noteCard.innerHTML = `
                <div class="note-card ${note.color} position-relative p-3">
                    <div class="note-header d-flex justify-content-between align-items-start pb-1">
                        <strong><em>${note.title}</em></strong>
                        <div class="dropdown">
                            <button class="btn btn-link p-0 border-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item edit-note" href="#" data-bs-toggle="modal"
                                        data-bs-target="#editNoteModal" data-note-id="${note.id}"
                                        data-note-color="${note.color}" data-note-title="${note.title}"
                                        data-note-content="${note.content}">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-share-fill"></i> Share
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#">
                                        <i class="bi bi-trash3-fill"></i> Delete
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-separator"></div>
                    <p class="mt-2">${note.content}</p>
                </div>
                `;
                container.appendChild(noteCard);
            });
        })
        .catch(error => {
            console.error('Error fetching notes:', error);
        });
});
</script>

{% endblock %}
