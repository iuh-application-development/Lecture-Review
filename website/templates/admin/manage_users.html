{% extends 'admin/base_admin.html' %}{% block content %}
<div class="content p-4 flex-grow-1">
  <!-- Tiêu đề trang -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h4 class="m-0 fw-bold">User Management</h4>
    <!-- Search box -->
    <div class="input-group" style="width: 300px;">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" id="searchUser" class="form-control" placeholder="Search user">
    </div>
  </div>

  <!-- Thanh filter -->
  <div class="d-flex align-items-center gap-3 mb-3">
    <div class="d-flex align-items-center gap-1">
      <label class="fw-semibold">Status:</label>
      <select id="statusFilter" class="form-select form-select-sm">
        <option value="all">All status</option>
        <option value="active" selected>Active</option>
        <option value="locked">Locked</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
    <button id="filterButton" class="btn btn-outline-secondary d-flex align-items-center gap-1">
      <i class="bi bi-funnel"></i>
      <span>Filter</span>
    </button>
  </div>

  <!-- Bảng danh sách User -->
  <div class="table-responsive border rounded">
    <table class="table table-striped table-hover m-0">
      <thead class="table-light">
        <tr>
          <th scope="col">User</th>
          <th scope="col">Status</th>
          <th scope="col">Last login</th>
          <th scope="col" style="width: 100px;">Actions</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
        <!-- Dữ liệu người dùng sẽ được hiển thị ở đây -->
      </tbody>
    </table>
  </div>

  <!-- Hiển thị thông tin phân trang -->
  <div class="mt-2 d-flex justify-content-between align-items-center">
    <small id="paginationInfo">Showing 0 to 0 of 0 entries</small>
    <nav>
      <ul class="pagination custom-pagination mb-0" id="paginationControls">
        <!-- Các nút phân trang sẽ được tạo động bởi JS -->
      </ul>
    </nav>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const userTableBody = document.getElementById('userTableBody');
    const paginationInfo = document.getElementById('paginationInfo');
    const paginationControls = document.getElementById('paginationControls');
    const statusFilter = document.getElementById('statusFilter');
    const searchUser = document.getElementById('searchUser');
    const filterButton = document.getElementById('filterButton');

    let currentPage = 1;
    const limit = 10;

    // Hàm gọi API để lấy danh sách người dùng
    function fetchUsers(page = 1, status = 'all', search = '') {
      fetch(`/admin/users?page=${page}&limit=${limit}&status=${status}&search=${search}`)
        .then(response => response.json())
        .then(data => {
          const users = data.users || [];
          const total = data.total || 0;
          const totalPages = Math.ceil(total / limit);

          // Hiển thị danh sách người dùng
          userTableBody.innerHTML = '';
          users.forEach(user => {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.onclick = () => {
              window.location.href = `/admin/user_detail/${user.id}`;
            };
            row.innerHTML = `
                        <td>${user.email}</td>
                        <td>
                            <span class="badge ${user.status === 'Active' ? 'bg-success' : 'bg-danger'}">
                                ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
                            </span>
                        </td>
                        <td>${user.last_login || 'N/A'}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-light border toggle-lock" data-user-id="${user.id}" data-status="${user.status}">
                                    <i class="bi ${user.status === 'Locked' ? 'bi-unlock' : 'bi-lock'}"></i>
                                </button>
                            </div>
                        </td>
                    `;

            // Thêm sự kiện click cho nút khóa/mở khóa
            row.querySelector('.toggle-lock').addEventListener('click', (event) => {
              event.stopPropagation();

              const btn = event.currentTarget; 
              const icon = btn.querySelector('i');

              let currentStatus = btn.getAttribute('data-status');
              const userId = btn.getAttribute('data-user-id');

              if (currentStatus === 'Locked') {
                icon.classList.replace('bi-lock', 'bi-unlock');
                btn.setAttribute('data-status', 'Active');
                currentStatus = 'Active';
              } else {
                icon.classList.replace('bi-unlock', 'bi-lock');
                btn.setAttribute('data-status', 'Locked');
                currentStatus = 'Locked';
              }

              fetch(`/admin/users/${userId}/toggle-lock`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: currentStatus })
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  fetchUsers(currentPage, statusFilter.value, searchUser.value);
                } else {
                  console.error('Error toggling lock:', data.message);
                }
              })
              .catch(error => console.error('Error:', error));
            });

            userTableBody.appendChild(row);
          });

          // Cập nhật thông tin phân trang
          paginationInfo.textContent = `Showing ${(page - 1) * limit + 1} to ${Math.min(page * limit, total)} of ${total} entries`;

          // Cập nhật giao diện phân trang
          updatePagination(page, totalPages);
        })
        .catch(error => console.error('Error fetching users:', error));
    }

    // Hàm cập nhật giao diện phân trang
    function updatePagination(currentPage, totalPages) {
      paginationControls.innerHTML = '';

      // Nút Previous
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage <= 1 ? 'disabled' : ''}`;
      const prevLink = document.createElement('a');
      prevLink.className = 'page-link';
      prevLink.href = '#';
      prevLink.innerHTML = '<i class="bi bi-chevron-left"></i>'; // Sử dụng biểu tượng mũi tên trái
      prevLink.addEventListener('click', function (e) {
        e.preventDefault();
        if (currentPage > 1) {
          fetchUsers(currentPage - 1, statusFilter.value, searchUser.value);
        }
      });
      prevLi.appendChild(prevLink);
      paginationControls.appendChild(prevLi);

      // Các số trang
      for (let page = 1; page <= totalPages; page++) {
        const li = document.createElement('li');
        li.className = `page-item ${page === currentPage ? 'active' : ''}`;
        const link = document.createElement('a');
        link.className = 'page-link';
        link.href = '#';
        link.textContent = page;
        link.addEventListener('click', function (e) {
          e.preventDefault();
          fetchUsers(page, statusFilter.value, searchUser.value);
        });
        li.appendChild(link);
        paginationControls.appendChild(li);
      }

      // Nút Next
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage >= totalPages ? 'disabled' : ''}`;
      const nextLink = document.createElement('a');
      nextLink.className = 'page-link';
      nextLink.href = '#';
      nextLink.innerHTML = '<i class="bi bi-chevron-right"></i>'; // Sử dụng biểu tượng mũi tên phải
      nextLink.addEventListener('click', function (e) {
        e.preventDefault();
        if (currentPage < totalPages) {
          fetchUsers(currentPage + 1, statusFilter.value, searchUser.value);
        }
      });
      nextLi.appendChild(nextLink);
      paginationControls.appendChild(nextLi);
    }

    // Xử lý sự kiện filter
    filterButton.addEventListener('click', function () {
      fetchUsers(1, statusFilter.value, searchUser.value);
    });

    // Khởi tạo: Lấy danh sách người dùng mặc định
    fetchUsers();
  });
</script>
{% endblock %}